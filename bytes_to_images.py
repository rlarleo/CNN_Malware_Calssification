import os
from math import log
import numpy as np
from PIL import Image

def convert_file(array, name):
    if array.shape[1]!=16:
        assert(False)
    b=int((array.shape[0]*16)**(0.5))
    b=2**(int(log(b)/log(2))+1)
    a=int(array.shape[0]*16/b)
    c = int(a * b / 16)
    array=array[:c,:]
    array=np.reshape(array,(a,b))
    im = Image.fromarray(np.uint8(array))
    im.save('imagesV2/malware/'+name+'.jpg', "JPEG")
    print ("Convert: " + 'malware/' + name + " \tTo: " + 'images/'+name + '.jpg' + "\n")




def convert_to_images(malware_path,image_path):
    malware_image_directory = os.path.join(image_path)
    malware_paths = os.listdir(malware_path)

    print("Convert exe files in: " + malware_path + " to images in: " + malware_image_directory)

    for malware in malware_paths:
        path = malware_path + "/" + malware
        f = open(path)
        array = []
        for line in f:
            xx = line.split()
            if len(xx) != 17:
                continue
            array.append([int(i, 16) if i != '??' else 0 for i in xx[1:]])
        convert_file(np.array(array), malware)
        del array
        f.close()

    print("\nTotal number of malicious exe files: ", len(malware_paths))
    # print("\nTotal number of malicious image files: ", len(malware_image_files))
